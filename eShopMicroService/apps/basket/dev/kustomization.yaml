apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: flux-apps
resources:
  - ../../base
configMapGenerator:
  - name: basketapi-dev-config        # Explicit name
    files:
      - values.yaml=values-dev.yaml
secretGenerator:
  - name: basketapi-dev-secret        # Explicit name
    files:
      - values.yaml=values-dev.yaml
generatorOptions:
  disableNameSuffixHash: true
patches:
  - target:
      kind: HelmRelease
      name: app-placeholder
    patch: |-
      - op: replace
        path: /metadata/name
        value: basketapi-dev              # Explicit name
      - op: replace
        path: /spec/releaseName
        value: basketapi-dev              # Explicit name
      - op: add
        path: /spec/valuesFrom/-
        value:
          kind: ConfigMap
          name: basketapi-dev-config      # Matches generator
          optional: false
      - op: add
        path: /spec/valuesFrom/-
        value:
          kind: Secret
          name: basketapi-dev-secret      # Matches generator
          optional: false