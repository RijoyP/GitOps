apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Root kustomization for all infrastructure components
# This file orchestrates the deployment of all tools to AKS using GitOps

metadata:
  name: infrastructure-root
  namespace: flux-system

resources:

  # - helm-oci-repository.yaml
  - helm-elastic-repository.yaml
  - helm-bitnami-repository.yaml

  # Phase 1: Service Mesh - Deploy first as it provides observability infrastructure
  # Istio must be deployed before other services for proper mesh injection
  #- istio/
  - ingress/
  # Phase 2: Monitoring Stack - Deploy early to capture metrics from all services
  # Prometheus should be available before other services start emitting metrics
  - prometheus/

  # Phase 3: Logging Stack - Deploy Elasticsearch before services that depend on it
  # Elasticsearch must be ready before Jaeger and Kibana
  - elasticsearch/

  # Phase 4: Visualization and UI Components
  # These depend on their respective backend services
  - grafana/       # Depends on Prometheus (implicit via datasource config)
  - kibana/        # Depends on Elasticsearch (explicit dependency in HelmRelease)

  # Phase 5: Distributed Tracing Stack
  # Tracing components can be deployed in parallel
  - zipkin/        # Independent tracing service
  - jaeger/        # Depends on Elasticsearch (explicit dependency in HelmRelease)

  # Phase 6: Message Broker - Can be deployed independently
  - rabbitmq/

  # Phase 7: Databases - Deploy last as they are backend services
  - postgresql/
  - sqlserver/
  - redis/


commonLabels:
  app.kubernetes.io/managed-by: fluxcd
  app.kubernetes.io/part-of: flux-system

commonAnnotations:
  fluxcd.io/managed: "true"